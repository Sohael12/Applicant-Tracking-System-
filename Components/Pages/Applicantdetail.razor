@page "/applications/history/{ApplicationId:int}"
@using Stageproject_ATS_AP2025Q2.Models
@using Stageproject_ATS_AP2025Q2.Services
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@inject StatusHistoryService StatusHistoryService
@inject ApplicationService ApplicationService
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject InterviewNoteService InterviewNoteService
@inject NavigationManager NavigationManager

<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-primary">Application History</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/applications" class="text-decoration-none">Applications</a></li>
                    <li class="breadcrumb-item active" aria-current="page">History #@ApplicationId</li>
                </ol>
            </nav>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="window.history.back()">
                <i class="bi bi-arrow-left me-2"></i>Back
            </button>
        </div>
    </div>

    <div class="row g-4">
        @if (application != null)
        {
            <!-- Application Info Card -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-person-badge text-primary me-2"></i>
                            Application Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center mb-4">
                            <div class="col-auto">
                                <!-- Initials Avatar -->
                               <div class="avatar-initials bg-gradient-primary text-primary rounded-circle d-flex align-items-center justify-content-center border border-3 border-primary"
     style="width: 80px; height: 80px; font-size: 1.75rem; font-weight: 600;">
    @GetUserInitials(application.User.FirstName, application.User.LastName)
</div>

                            </div>
                            <div class="col">
                                <h4 class="mb-1">@application.User.FirstName @application.User.LastName</h4>
                                <p class="text-muted mb-0">Candidate</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-muted small mb-1">Email</label>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-envelope text-primary me-2"></i>
                                        <span>@application.User.Email</span>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(application.User.PhoneNumber))
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted small mb-1">Phone</label>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-telephone text-primary me-2"></i>
                                            <span>@application.User.PhoneNumber</span>
                                        </div>
                                    </div>
                                }

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-muted small mb-1">Address</label>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-geo-alt text-primary me-2"></i>
                                        <span>@application.User.Address</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-muted small mb-1">Vacancy</label>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-briefcase text-primary me-2"></i>
                                        <a href="/vacancy/@application.Vacancy.Id" 
                                           class="text-decoration-none">
                                            @application.Vacancy.Title
                                        </a>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-muted small mb-1">Motivation</label>
                                    <p class="mb-0 text-break">@application.Motivation</p>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-muted small mb-1">About Yourself</label>
                                    <p class="mb-0 text-break">@application.AboutYourself</p>
                                </div>

                                @if (!string.IsNullOrWhiteSpace(application.ResumeFilePath))
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted small mb-1">Resume</label>
                                        <div>
                                            <a href="@application.ResumeFilePath" target="_blank" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-download me-1"></i>Download Resume
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Interview Schedule -->
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <i class="bi bi-calendar-check text-primary me-2"></i>
                        Interview Schedule
                    </h5>
                    <a href="/create-meeting" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>New Meeting
                    </a>
                </div>
                <div class="card-body">
                    @if (interviewNotes.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">Time</th>
                                        <th scope="col">Candidate</th>
                                        <th scope="col">Comment</th>
                                        <th scope="col" class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var note in interviewNotes.OrderBy(n => n.InterviewDate).ThenBy(n => n.InterviewTime))
                                    {
                                        <tr>
                                            <td>
                                                <div class="fw-semibold">@note.InterviewDate.ToString("dd MMM yyyy")</div>
                                            </td>
                                            <td>@note.InterviewTime.ToString(@"hh\:mm")</td>
                                            <td>@note.FullName</td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(note.Comment))
                                                {
                                                    <span class="text-truncate d-inline-block" style="max-width: 150px;" 
                                                          title="@note.Comment">
                                                        @note.Comment
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted fst-italic">-</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-primary" 
                                                            @onclick="() => EditMeeting(note)">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" 
                                                            @onclick="() => DeleteMeeting(note.Id)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                            </div>
                            <h5 class="text-muted">No interviews scheduled</h5>
                            <p class="text-muted mb-3">No interviews have been scheduled for this application yet.</p>
                            <a href="/create-meeting" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-1"></i>Schedule Interview
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Status History -->
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 border-bottom">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <i class="bi bi-clock-history text-primary me-2"></i>
                        Status History
                    </h5>
                </div>
                <div class="card-body">
                    @if (statusHistoryList.Any())
                    {
                        <div class="timeline">
                            @foreach (var history in statusHistoryList.OrderByDescending(h => h.Date))
                            {
                                <div class="timeline-item mb-4">
                                    <div class="d-flex">
                                        <div class="timeline-badge bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                             style="width: 40px; height: 40px;">
                                            <i class="bi bi-arrow-repeat text-white"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                <h6 class="mb-0">@GetDisplayName(history.Status)</h6>
                                                <small class="text-muted">@history.Date.ToString("dd MMM yyyy HH:mm")</small>
                                            </div>
                                            @if (!string.IsNullOrWhiteSpace(history.Comment))
                                            {
                                                <p class="text-muted mb-2">@history.Comment</p>
                                            }
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                                        @onclick="() => EditStatus(history)">
                                                    <i class="bi bi-pencil me-1"></i>Edit
                                                </button>
                                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                                        @onclick="() => DeleteStatus(history)">
                                                    <i class="bi bi-trash me-1"></i>Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2 mb-0">No status updates recorded</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Status Form -->
        @if (editContext != null)
        {
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-plus-circle text-primary me-2"></i>
                            @((editingStatusHistory != null) ? "Edit Status" : "Add New Status")
                        </h5>
                    </div>
                    <div class="card-body">
                        <EditForm EditContext="@editContext" OnValidSubmit="HandleValidSubmit">
                            <DataAnnotationsValidator />
                            <Blazorise.ValidationSummary class="alert alert-danger" />

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Status <span class="text-danger">*</span></label>
                                <InputSelect @bind-Value="statusModel.Status" class="form-select">
                                    <option value="">-- Select Status --</option>
                                    @foreach (var status in Enum.GetValues(typeof(StatusHistory.ApplicationStatus)).Cast<StatusHistory.ApplicationStatus>())
                                    {
                                        <option value="@status">@GetDisplayName(status)</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => statusModel.Status)" class="text-danger small" />
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Comment</label>
                                <InputTextArea @bind-Value="statusModel.Comment" 
                                               class="form-control" 
                                               placeholder="Optional comment..." 
                                               rows="3" />
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                @if (editingStatusHistory != null)
                                {
                                    <button type="button" class="btn btn-outline-secondary me-md-2" 
                                            @onclick="CancelEdit">
                                        Cancel
                                    </button>
                                }
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-1"></i>
                                    @((editingStatusHistory != null) ? "Update Status" : "Add Status")
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public int ApplicationId { get; set; }

    private List<StatusHistory> statusHistoryList = new();
    private Application? application;
    private StatusHistory statusModel = new();
    private StatusHistory? editingStatusHistory;
    private EditContext? editContext;

    private List<InterviewNote> interviewNotes = new();

    protected override async Task OnInitializedAsync()
    {
        application = await ApplicationService.GetByIdAsync(ApplicationId);
        statusHistoryList = await StatusHistoryService.GetStatusHistoryByApplicationIdAsync(ApplicationId);
        interviewNotes = await InterviewNoteService.GetInterviewNotesByApplicationIdAsync(ApplicationId);

        statusModel.ApplicationId = ApplicationId;
        editContext = new EditContext(statusModel);
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (editingStatusHistory != null)
            {
                editingStatusHistory.Status = statusModel.Status;
                editingStatusHistory.Comment = statusModel.Comment;
                editingStatusHistory.Date = DateTime.Now;
                await StatusHistoryService.UpdateStatusHistoryAsync(editingStatusHistory);
                editingStatusHistory = null;
            }
            else
            {
                var newStatus = new StatusHistory
                {
                    ApplicationId = ApplicationId,
                    Status = statusModel.Status,
                    Comment = statusModel.Comment,
                    Date = DateTime.Now
                };
                await StatusHistoryService.SaveStatusHistoryAsync(newStatus);
            }

            statusHistoryList = await StatusHistoryService.GetStatusHistoryByApplicationIdAsync(ApplicationId);
            statusModel = new StatusHistory { ApplicationId = ApplicationId };
            editContext = new EditContext(statusModel);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error saving status: {ex.Message}");
        }
    }

    private void EditStatus(StatusHistory status)
    {
        editingStatusHistory = status;
        statusModel = new StatusHistory
        {
            Id = status.Id,
            ApplicationId = status.ApplicationId,
            Status = status.Status,
            Comment = status.Comment,
            Date = status.Date
        };
        editContext = new EditContext(statusModel);
    }

    private async Task DeleteStatus(StatusHistory status)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the status '{GetDisplayName(status.Status)}'?");
        if (confirmed)
        {
            await StatusHistoryService.DeleteStatusHistoryAsync(status.Id);
            statusHistoryList = await StatusHistoryService.GetStatusHistoryByApplicationIdAsync(ApplicationId);
            StateHasChanged();
        }
    }

    private void EditMeeting(InterviewNote note)
    {
        NavigationManager.NavigateTo($"/edit-meeting/{note.Id}");
    }

    private async Task DeleteMeeting(int noteId)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this meeting?");
        if (confirmed)
        {
            await InterviewNoteService.DeleteInterviewNoteAsync(noteId);
            interviewNotes = await InterviewNoteService.GetInterviewNotesByApplicationIdAsync(ApplicationId);
            StateHasChanged();
        }
    }

    private string GetDisplayName(Enum enumValue)
    {
        var display = enumValue.GetType()
                              .GetMember(enumValue.ToString())
                              .FirstOrDefault()
                              ?.GetCustomAttribute<DisplayAttribute>();
        return display?.Name ?? enumValue.ToString();
    }

    private void CancelEdit()
    {
        editingStatusHistory = null;
        statusModel = new StatusHistory { ApplicationId = ApplicationId };
        editContext = new EditContext(statusModel);
    }

    private string GetUserInitials(string firstName, string lastName)
    {
        var first = firstName?.FirstOrDefault().ToString() ?? "";
        var last = lastName?.FirstOrDefault().ToString() ?? "";
        return $"{first}{last}".ToUpper();
    }
}