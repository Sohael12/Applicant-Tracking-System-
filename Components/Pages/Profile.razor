@page "/profile"
@attribute [Authorize]
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Stageproject_ATS_AP2025Q2.Data
@using Stageproject_ATS_AP2025Q2.Interfaces
@using Stageproject_ATS_AP2025Q2.Models
@using Stageproject_ATS_AP2025Q2.Services
@inject AuthenticationStateProvider AuthProvider
@inject ApplicationService ApplicationService
@inject IVacancyRepository VacancyRepo
@inject UserManager<AppUser> UserManager
@inject AppDbContext Context
@rendermode InteractiveServer

<main class="max-w-7xl mx-auto px-6 py-10">
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">My Profile</h1>
        <p class="text-gray-600">Manage your personal information and application history</p>
    </div>

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center text-green-800">
            <i class="fas fa-check-circle mr-3 text-green-500"></i>
            <span>@SuccessMessage</span>
        </div>
    }

     @if (currentUser != null)
    {
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <!-- Profile Information -->
            <div class="xl:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <div class="flex-shrink-0 h-12 w-12 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user text-white text-lg"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-semibold text-gray-900">Personal Information</h2>
                            <p class="text-gray-600">Update your contact details</p>
                        </div>
                    </div>

                    <EditForm Model="currentUser" OnValidSubmit="SaveProfile">
                        <DataAnnotationsValidator />
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    First Name <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="currentUser.FirstName" 
                                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                <ValidationMessage For="@(() => currentUser.FirstName)" class="text-red-600 text-sm mt-1" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Last Name <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="currentUser.LastName" 
                                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                <ValidationMessage For="@(() => currentUser.LastName)" class="text-red-600 text-sm mt-1" />
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" value="@currentUser.Email" disabled
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500" />
                                <p class="text-sm text-gray-500 mt-1">Email cannot be changed</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                <InputText @bind-Value="currentUser.Address" 
                                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                         placeholder="Enter your full address" />
                            </div>
                        </div>

                        <div class="flex justify-end mt-6 pt-6 border-t border-gray-200">
                            <button type="submit" 
                                    class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>

            <!-- User Summary -->
            <div class="xl:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="text-center mb-6">
                        <div class="flex justify-center mb-4">
                            <div class="h-20 w-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-2xl">
                                @GetUserInitials()
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">@currentUser.FirstName @currentUser.LastName</h3>
                        <p class="text-gray-600 text-sm">@currentUser.Email</p>
                        <div class="mt-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-user-shield mr-1"></i>@UserRole
                            </span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">Applications</span>
                            <span class="font-medium text-gray-900">@applications.Count</span>
                        </div>
                        @if (!string.IsNullOrEmpty(currentUser.Address))
                        {
                            <div class="flex items-start text-sm">
                                <i class="fas fa-map-marker-alt mr-2 text-gray-400 mt-0.5"></i>
                                <span class="text-gray-600">@currentUser.Address</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Applications Section ONLY for Users (not Admins or Managers) -->
        @if (!IsAdmin && !IsManager)
        {
            <div class="mt-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-12 w-12 bg-green-500 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-alt text-white text-lg"></i>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-xl font-semibold text-gray-900">My Applications</h2>
                                <p class="text-gray-600">Track your job application status</p>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            Total: @applications.Count applications
                        </div>
                    </div>

                    @if (applications.Any())
                    {
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            @foreach (var app in applications)
                            {
                                var vacancy = vacancies.FirstOrDefault(v => v.Id == app.VacancyId);
                                var latestStatus = app.StatusHistories?.OrderByDescending(s => s.Date).FirstOrDefault();

                                <div class="border border-gray-200 rounded-lg p-5 hover:shadow-md transition-shadow duration-300">
                                    <div class="flex items-start justify-between mb-3">
                                        <h4 class="text-lg font-semibold text-gray-900 truncate">@vacancy?.Title</h4>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @GetStatusColor(latestStatus?.Status.ToString())">
                                            <i class="@GetStatusIcon(latestStatus?.Status.ToString()) mr-1"></i>
                                            @(latestStatus?.Status.ToString() ?? "Pending")
                                        </span>
                                    </div>

                                    <div class="space-y-2 mb-4">
                                        @if (latestStatus != null)
                                        {
                                            <div class="flex items-center text-sm text-gray-600">
                                                <i class="fas fa-clock mr-2 text-gray-400 w-4"></i>
                                                <span>Updated @latestStatus.Date.ToString("MMM dd, yyyy")</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(app.Motivation))
                                        {
                                            <p class="text-sm text-gray-600 line-clamp-2">
                                                <strong>Motivation:</strong> @app.Motivation
                                            </p>
                                        }
                                    </div>

                                    <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                                        <NavLink href="@($"/vacancy/{app.VacancyId}")" 
                                                 class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium">
                                            <i class="fas fa-eye mr-1"></i>View Vacancy
                                        </NavLink>
                                        <NavLink href="@($"/applications/history/{app.Id}")" 
                                                 class="inline-flex items-center text-sm text-gray-600 hover:text-gray-800">
                                            <i class="fas fa-history mr-1"></i>History
                                        </NavLink>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-8 bg-gray-50 rounded-lg border border-gray-200">
                            <i class="fas fa-file-import text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-600 mb-2">No applications yet</h3>
                            <p class="text-gray-500 mb-4">Start applying to see your applications here</p>
                            <NavLink href="/vacancies" 
                                     class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                <i class="fas fa-search mr-2"></i>Browse Vacancies
                            </NavLink>
                        </div>
                    }
                </div>
            </div>
        }
    }
</main>
@code {
    private AppUser? currentUser;
    private List<Application> applications = new();
    private List<Vacancy> vacancies = new();
    private bool IsAdmin = false;
    private bool IsManager = false;
    private string UserRole = "User";
    private string SuccessMessage = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                currentUser = await UserManager.FindByIdAsync(userId);

                // Rol ophalen uit UserRole tabel
                var role = await Context.UserRoles
                    .Where(r => r.UserId == userId)
                    .Select(r => r.Role)
                    .FirstOrDefaultAsync();

                IsAdmin = role == "Admin";
                IsManager = role == "Manager";
                UserRole = role ?? "User";

                if (!IsAdmin && !IsManager)
                {
                    applications = await ApplicationService.GetByUserIdAsync(userId);
                    vacancies = await VacancyRepo.GetAllAsync();
                }
            }
        }
    }

    private async Task SaveProfile()
    {
        if (currentUser == null) return;

        try
        {
            var user = await UserManager.FindByIdAsync(currentUser.Id);
            if (user != null)
            {
                user.FirstName = currentUser.FirstName;
                user.LastName = currentUser.LastName;
                user.Address = currentUser.Address;

                await UserManager.UpdateAsync(user);
                SuccessMessage = "Profile updated successfully";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            SuccessMessage = $"Error updating profile: {ex.Message}";
            StateHasChanged();
        }
    }

    private string GetUserInitials()
    {
        if (currentUser == null) return "??";
        var first = currentUser.FirstName?.FirstOrDefault().ToString() ?? "";
        var last = currentUser.LastName?.FirstOrDefault().ToString() ?? "";
        return $"{first}{last}".ToUpper();
    }

    private string GetStatusColor(string? status)
    {
        return status switch
        {
            "Accepted" or "Approved" => "bg-green-100 text-green-800",
            "Rejected" => "bg-red-100 text-red-800",
            "Interview Scheduled" => "bg-blue-100 text-blue-800",
            "InProgress" or "UnderReview" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private string GetStatusIcon(string? status)
    {
        return status switch
        {
            "Accepted" or "Approved" => "fas fa-check",
            "Rejected" => "fas fa-times",
            "Interview Scheduled" => "fas fa-calendar-check",
            "InProgress" or "UnderReview" => "fas fa-sync-alt",
            _ => "fas fa-clock"
        };
    }
}