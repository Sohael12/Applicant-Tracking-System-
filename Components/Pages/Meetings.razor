@page "/meetings"
@using Microsoft.AspNetCore.Components.Authorization
@using Stageproject_ATS_AP2025Q2.Services
@using Stageproject_ATS_AP2025Q2.Models
@inject InterviewNoteService NoteService
@inject NavigationManager NavigationManager
@inject ApplicationService ApplicationService
@inject AuthenticationStateProvider AuthProvider
@inject UserRoleService RoleService
@inject IJSRuntime JSRuntime
@inject IServiceProvider ServiceProvider
@rendermode InteractiveServer

<main class="max-w-7xl mx-auto px-6 py-10">
    <!-- Role Check -->
    @if (!(IsAdmin || IsManager))
    {
        <div class="text-center text-red-600 font-bold text-xl bg-red-50 p-6 rounded-lg border border-red-200">
            <i class="fas fa-ban mr-2"></i>You do not have access to this page.
        </div>
    }
    else
    {
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Meetings Agenda</h1>
            <p class="text-gray-600">Manage and view all scheduled interviews</p>
        </div>

        <!-- Success and error messages -->
        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center text-green-800">
                <i class="fas fa-check-circle mr-3 text-green-500"></i>
                <span>@SuccessMessage</span>
            </div>
        }
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center text-red-800">
                <i class="fas fa-exclamation-triangle mr-3 text-red-500"></i>
                <span>@ErrorMessage</span>
            </div>
        }

        <!-- Header with New Meeting Button -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
            <div>
                <h2 class="text-2xl font-semibold text-gray-900">Scheduled Interviews</h2>
                <p class="text-gray-600 mt-1">Total: @notes?.Count meetings</p>
            </div>

            <NavLink href="/create-meeting"
                     class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-medium">
                <i class="fas fa-plus-circle mr-2"></i>New Meeting
            </NavLink>
        </div>

        <!-- Loading state -->
        @if (notes == null)
        {
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-blue-500 text-3xl mb-3"></i>
                <p class="text-gray-600">Loading meetings...</p>
            </div>
        }
        else if (!notes.Any())
        {
            <div class="text-center py-12 bg-gray-50 rounded-xl border border-gray-200">
                <i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No meetings scheduled</h3>
                <p class="text-gray-500 mb-4">Get started by creating your first meeting.</p>
                <NavLink href="/create-meeting"
                         class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-medium">
                    <i class="fas fa-plus-circle mr-2"></i>Create First Meeting
                </NavLink>
            </div>
        }
        else
        {
            <!-- Meeting cards grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                @foreach (var note in notes.OrderBy(n => n.InterviewDate).ThenBy(n => n.InterviewTime))
                {
                    var application = applications.FirstOrDefault(a => a.Id == note.ApplicationId);
                    var vacancyTitle = application?.Vacancy?.Title ?? "Vacancy not found";
                    var interviewDate = note.InterviewDate.ToString("MMM dd, yyyy");
                    var interviewTime = note.InterviewTime.ToString(@"hh\:mm");

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-300">
                        <div class="p-6">
                            <!-- Candidate info -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-12 w-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-lg">
                                        @GetCandidateInitials(note.FullName)
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-lg font-semibold text-gray-900">@note.FullName</h3>
                                        <p class="text-sm text-gray-500">@vacancyTitle</p>
                                    </div>
                                </div>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <i class="fas fa-clock mr-1"></i>@interviewTime
                                </span>
                            </div>

                            <!-- Details -->
                            <div class="space-y-3 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-calendar-alt mr-2 text-gray-400 w-4"></i>
                                    <span>@interviewDate</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-user-tie mr-2 text-gray-400 w-4"></i>
                                    <span>Created by @note.CreatedBy</span>
                                </div>
                                @if (!string.IsNullOrEmpty(note.Comment))
                                {
                                    <div class="text-sm text-gray-600">
                                        <strong>Comment:</strong> @note.Comment
                                    </div>
                                }
                            </div>

                            <!-- Action buttons -->
                            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                                <div class="flex items-center space-x-3">
                                    <NavLink href="@($"/edit-meeting/{note.Id}")"
                                             class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                        <i class="fas fa-edit mr-1"></i>Edit
                                    </NavLink>

                                    <button @onclick="() => CancelMeeting(note.Id)"
                                            class="inline-flex items-center px-3 py-1.5 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors text-sm font-medium">
                                        <i class="fas fa-ban mr-1"></i>Cancel
                                    </button>

                                    <button @onclick="() => DeleteMeeting(note.Id)"
                                            class="inline-flex items-center px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                </div>

                                <NavLink href="@($"/meeting-details/{note.Id}")"
                                         class="text-gray-400 hover:text-blue-600 transition-colors">
                                    <i class="fas fa-external-link-alt"></i>
                                </NavLink>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Summary -->
            <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex flex-wrap items-center justify-between text-sm text-gray-600">
                    <div class="flex items-center space-x-6">
                        <span><strong>Total meetings:</strong> @notes.Count</span>
                        <span><strong>Today:</strong> @GetTodaysMeetingsCount()</span>
                        <span><strong>This week:</strong> @GetThisWeeksMeetingsCount()</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        <span>Last updated: @DateTime.Now.ToString("MMM dd, yyyy HH:mm")</span>
                    </div>
                </div>
            </div>
        }
    }
</main>

@code {
    // Role flags
    private bool IsAdmin = false;
    private bool IsManager = false;

    // Lists
    private List<Application> applications = new();
    private List<InterviewNote> notes = new();

    // Messages
    private string SuccessMessage = "";
    private string ErrorMessage = "";

    // Helper: generate initials from candidate name
    private string GetCandidateInitials(string fullName)
    {
        if (string.IsNullOrEmpty(fullName)) return "??";
        var names = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (names.Length >= 2) return $"{names[0][0]}{names[1][0]}".ToUpper();
        else if (names.Length == 1) return names[0].Substring(0, Math.Min(2, names[0].Length)).ToUpper();
        return "??";
    }

    // Helper: count meetings today
    private int GetTodaysMeetingsCount()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        return notes.Count(n => n.InterviewDate == today);
    }

    // Helper: count meetings in current week
    private int GetThisWeeksMeetingsCount()
    {
        var today = DateTime.Today;
        var startOfWeek = today.AddDays(-(int)today.DayOfWeek);
        var endOfWeek = startOfWeek.AddDays(7);
        return notes.Count(n => n.InterviewDate >= DateOnly.FromDateTime(startOfWeek) && n.InterviewDate < DateOnly.FromDateTime(endOfWeek));
    }

    // Initialize data + role check
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            using var scope = ServiceProvider.CreateScope();
            var roleService = scope.ServiceProvider.GetRequiredService<UserRoleService>();
            IsAdmin = await roleService.IsAdminAsync(userId);
            IsManager = await roleService.IsManagerAsync(userId);
        }

        if (IsAdmin || IsManager)
        {
            try
            {
                applications = await ApplicationService.GetAllAsync();
                notes = await NoteService.GetAllNotesAsync();
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error loading meetings: {ex.Message}";
            }
        }
    }

    // ðŸ”¹ Cancel meeting (remove event + send email + delete note)
    private async Task CancelMeeting(int id)
    {
        try
        {
            var meetingService = ServiceProvider.GetRequiredService<MeetingService>();
            await meetingService.DeleteMeetingAsync(id);

            notes = await NoteService.GetAllNotesAsync();
            SuccessMessage = "Meeting cancelled successfully. The participant has been notified.";
            ErrorMessage = "";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cancelling meeting: {ex.Message}";
            SuccessMessage = "";
        }
        finally
        {
            StateHasChanged();
        }
    }

    // ðŸ”¸ Delete meeting from database only
    private async Task DeleteMeeting(int id)
    {
        try
        {
            await NoteService.DeleteNoteAsync(id);

            notes = await NoteService.GetAllNotesAsync();
            SuccessMessage = "Meeting deleted from database.";
            ErrorMessage = "";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error deleting meeting: {ex.Message}";
            SuccessMessage = "";
        }
        finally
        {
            StateHasChanged();
        }
    }
}
